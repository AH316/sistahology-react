# E2E Test Setup Guide

**Audience**: Developers maintaining the Playwright test suite
**Last Updated**: November 2, 2025

---

## Overview

The Sistahology E2E test suite uses a **two-user strategy** to comprehensively test both regular user workflows and admin-specific features. This approach enables role-based access control (RBAC) testing across all browser configurations.

### Test Users

| User | Email | Purpose | Admin Role |
|------|-------|---------|------------|
| **Regular User** | `e2e.user@sistahology.dev` | Standard journaling workflows | ❌ No |
| **Admin User** | `e2e.admin@sistahology.dev` | CMS management, user administration | ✅ Yes |

---

## Environment Configuration

### 1. Create `.env.test` File

Create a `.env.test` file in the project root with these credentials:

```bash
# Regular E2E test user (non-admin)
E2E_EMAIL=e2e.user@sistahology.dev
E2E_PASSWORD=[SECURE_PASSWORD_HERE]

# Admin E2E test user
E2E_ADMIN_EMAIL=e2e.admin@sistahology.dev
E2E_ADMIN_PASSWORD=[SECURE_PASSWORD_HERE]

# Supabase connection
VITE_SUPABASE_URL=https://[your-project-ref].supabase.co
VITE_SUPABASE_ANON_KEY=[your-anon-key]
```

**Security Notes**:
- Never commit `.env.test` to version control
- Use strong passwords (8+ chars, uppercase, lowercase, numbers, special chars)
- Rotate credentials every 90 days or after team changes

---

## User Setup Process

### Creating Test Users

**Option 1: Manual Creation via Supabase Dashboard**

1. Navigate to Authentication > Users in Supabase dashboard
2. Click "Add User" → "Create new user"
3. Enter email and password for each test user
4. Verify email confirmation emails if required

**Option 2: Programmatic Creation (Recommended)**

```bash
# Create both test users with a script
npm run create:test-users

# Or manually via Supabase API
curl -X POST 'https://[project-ref].supabase.co/auth/v1/signup' \
  -H 'apikey: [anon-key]' \
  -H 'Content-Type: application/json' \
  -d '{"email": "e2e.user@sistahology.dev", "password": "[password]"}'
```

---

## Admin Role Management

### Granting Admin Role

The admin user requires the `is_admin` flag in the `profiles` table. Use one of these methods:

**Method 1: NPM Script (Easiest)**

```bash
# Grant admin role to default admin user
npm run set:admin

# Grant admin role to specific user
npm run set:admin -- --email e2e.admin@sistahology.dev
```

**Method 2: Direct SQL Query**

```sql
-- Run in Supabase SQL Editor
UPDATE profiles
SET is_admin = true
WHERE id = (
  SELECT id FROM auth.users
  WHERE email = 'e2e.admin@sistahology.dev'
);
```

**Method 3: Admin Setup Script (Used by Tests)**

The `tests/admin-setup.ts` file automatically grants admin role during test initialization:

```typescript
// Runs before authAdmin project tests
// 1. Signs in with admin credentials
// 2. Checks if user has admin role
// 3. Grants admin role if missing (requires .env.scripts)
// 4. Saves authenticated session to tests/.auth/admin.json
```

### Verifying Admin Role

```bash
# Check admin status for a user
npm run verify:admin -- --email e2e.admin@sistahology.dev

# Or via SQL
SELECT email, is_admin FROM profiles p
JOIN auth.users u ON p.id = u.id
WHERE u.email = 'e2e.admin@sistahology.dev';
```

---

## Auth File Generation

### Storage State Files

Playwright saves authenticated sessions as JSON files to avoid re-authentication on every test:

| File | User | Generated By | Purpose |
|------|------|--------------|---------|
| `tests/.auth/user.json` | Regular user | `tests/global-setup.ts` | Standard authenticated tests |
| `tests/.auth/admin.json` | Admin user | `tests/admin-setup.ts` | Admin-specific tests |

### Generation Process

**Automatic (Recommended)**

```bash
# Run tests - auth files auto-generate on first run
npm run test:e2e

# Or explicitly trigger setup
npx playwright test --project=setup
npx playwright test --project=setupAdmin
```

**Manual Regeneration**

```bash
# Delete existing auth files
rm tests/.auth/user.json tests/.auth/admin.json

# Re-run test setup
npm run test:e2e
```

### Auth File Structure

```json
{
  "cookies": [...],
  "origins": [
    {
      "origin": "http://localhost:5173",
      "localStorage": [
        {
          "name": "supabase-auth-token",
          "value": "{\"access_token\":\"...\",\"user\":{...}}"
        }
      ]
    }
  ]
}
```

**Important**: Auth files contain access tokens. Never commit `tests/.auth/` to version control.

---

## Auth Token Management

### Token Expiration

Test auth sessions expire after 1 hour (Supabase default). Expired tokens cause tests to fail with "not authenticated" errors.

**Check Token Status**

```bash
# Verify both auth tokens are valid
npm run test:check-auth
```

Output:
```
✅ User Session: Token valid for 52 minutes
✅ Admin Session: Token valid for 48 minutes

✅ All auth sessions are valid
```

**Regenerate Expired Tokens**

```bash
# Regenerate both user and admin sessions
npx playwright test --project=setupAdmin

# Or use the refresh script directly
npx tsx scripts/refreshUserAuth.ts
```

This creates fresh sessions in:
- `tests/.auth/user.json` (regular user)
- `tests/.auth/admin.json` (admin user)

**Automated Token Checks**

The `test:admin-cms` script automatically checks token validity before running:

```bash
# This runs test:check-auth first, then admin tests
npm run test:admin-cms
```

---

## Baseline Screenshot Generation

Visual regression tests compare screenshots against baseline images. On first run, baselines don't exist and must be generated.

### Generate Baselines

```bash
# Generate all admin dashboard baselines (390px, 768px, 1280px viewports)
npx playwright test tests/admin-dashboard-stats.spec.ts --update-snapshots --project=authAdmin

# Generate baselines for admin CMS pages
npx playwright test tests/admin-cms-pages.spec.ts --update-snapshots --project=authAdmin

# Generate baselines for admin tokens
npx playwright test tests/admin-tokens.spec.ts --update-snapshots --project=authAdmin
```

**Baseline Storage**

Baselines are stored in viewport-specific directories:
- `tests/artifacts/admin/390/` - Mobile (iPhone 12)
- `tests/artifacts/admin/768/` - Tablet (iPad)
- `tests/artifacts/admin/1280/` - Desktop

**When to Regenerate**

- After intentional UI changes (new features, styling updates)
- When baseline comparison tests fail unexpectedly
- After major dependency updates (React, Tailwind, etc.)

**Safety Tip**: Always review diff screenshots in `tests/artifacts/test-results/` before accepting new baselines.

---

## Test Execution

### Running Test Suite

```bash
# Run all security tests (both users)
npm run test:security

# Run only regular user tests
npx playwright test --project=authUser

# Run only admin tests (with automatic token check)
npm run test:admin-cms

# Run specific test file
npx playwright test tests/security.spec.ts

# Debug mode with UI
npx playwright test --debug tests/security.spec.ts
```

### Browser Configurations

The test suite runs across 6 configurations:

| Project | Auth | Viewport | Purpose |
|---------|------|----------|---------|
| `chromium` | ❌ None | 1280x720 | Unauthenticated tests |
| `authUser` | ✅ Regular | 1280x720 | Standard workflows |
| `authAdmin` | ✅ Admin | 1280x720 | Admin features |
| `mobile-390` | ✅ Both | 390x844 | Mobile responsiveness |
| `tablet-768` | ✅ Both | 768x1024 | Tablet experience |
| `desktop-1280` | ✅ Both | 1280x720 | Desktop layout |

---

## Troubleshooting

### Issue: "Admin tests are skipped"

**Symptoms**: Admin tests show as "skipped" in test results

**Causes**:
1. Missing `E2E_ADMIN_EMAIL` or `E2E_ADMIN_PASSWORD` in `.env.test`
2. Admin setup script failed to run
3. `tests/.auth/admin.json` not generated

**Solution**:
```bash
# 1. Verify .env.test has admin credentials
cat .env.test | grep ADMIN

# 2. Manually run admin setup
npx playwright test --project=setupAdmin

# 3. Check auth file exists
ls -la tests/.auth/admin.json

# 4. If missing, verify Supabase credentials are correct
```

---

### Issue: "Authentication failed" during test run

**Symptoms**: Tests fail with "Error: locator.click: Timeout" on login

**Causes**:
1. Incorrect credentials in `.env.test`
2. Test user deleted from Supabase
3. Session expired in auth file

**Solution**:
```bash
# 1. Verify user exists in Supabase dashboard
# Navigate to Authentication > Users

# 2. Test credentials manually
npm run test:login -- --email e2e.user@sistahology.dev

# 3. Regenerate auth files
rm tests/.auth/*.json
npm run test:e2e
```

---

### Issue: "Admin role not detected" in tests

**Symptoms**: Admin user cannot access `/admin` routes

**Causes**:
1. `is_admin` flag not set in `profiles` table
2. Session cached before admin role granted
3. RLS policies blocking admin access

**Solution**:
```bash
# 1. Grant admin role
npm run set:admin -- --email e2e.admin@sistahology.dev

# 2. Regenerate admin auth file
rm tests/.auth/admin.json
npx playwright test --project=setupAdmin

# 3. Verify in Supabase dashboard
# SQL Editor: SELECT is_admin FROM profiles WHERE id = (SELECT id FROM auth.users WHERE email = 'e2e.admin@sistahology.dev');
```

---

### Issue: "Test timeout" on navigation

**Symptoms**: Tests exceed 30s timeout waiting for page load

**Causes**:
1. Development server not running (`npm run dev`)
2. Network issues or slow response times
3. React app stuck in loading state

**Solution**:
```bash
# 1. Verify dev server is running
curl http://localhost:5173
# Should return HTML

# 2. Check for console errors
npx playwright test --debug tests/security.spec.ts
# Inspect browser console

# 3. Increase timeout for slow environments
# In playwright.config.ts:
# timeout: 60000 // 60 seconds
```

---

### Issue: "Session expired" or "Invalid Refresh Token" during test runs

**Symptoms**: Tests fail with "Invalid Refresh Token: Refresh Token Not Found" or auth errors

**Causes**:
1. Supabase session tokens expire (default 1 hour)
2. Auth files generated hours/days ago
3. Long test suite duration exceeds token lifetime

**Solution**:
```bash
# 1. Check if tokens are expired
npm run test:check-auth

# 2. If expired, regenerate fresh auth files
npx playwright test --project=setupAdmin

# 3. For manual refresh of user session only
npx tsx scripts/refreshUserAuth.ts

# 4. Automated approach: use test:admin-cms which checks tokens first
npm run test:admin-cms
```

**Prevention**:
- Run `npm run test:check-auth` before long test runs
- Split test suite into smaller batches if runtime > 1 hour
- Regenerate auth files daily in CI/CD pipelines

---

## Maintenance Checklist

### Weekly
- [ ] Verify test users exist in Supabase dashboard
- [ ] Run full test suite and review results
- [ ] Check for expired sessions (regenerate auth files)

### Monthly
- [ ] Rotate test user passwords
- [ ] Update `.env.test` with new credentials
- [ ] Regenerate auth files with new sessions
- [ ] Review and update test coverage

### After Code Changes
- [ ] Run regression tests (`npm run test:regression`)
- [ ] Update auth selectors if Navigation component changed
- [ ] Regenerate snapshots if UI modified (`npm run snap:home`)
- [ ] Verify admin routes still require authentication

---

## Best Practices

1. **Isolate Test Data**: Use unique test user accounts separate from development/staging users
2. **Session Management**: Regenerate auth files daily or after significant auth changes
3. **Credential Rotation**: Update passwords quarterly and after team member departures
4. **CI/CD Integration**: Store credentials in secure environment variables, not in code
5. **Cleanup**: Delete test data (journals, entries) periodically to prevent bloat
6. **Monitoring**: Track test execution times; slow tests may indicate performance regressions

---

## Related Documentation

- **SECURITY_TEST_RESULTS.md** - Comprehensive test results and failure analysis
- **TESTING.md** - Overall testing strategy and coverage
- **ACCESSIBILITY_COMPLIANCE_STATUS.md** - WCAG compliance verification
- **playwright.config.ts** - Test configuration and browser projects

---

## Contact & Support

**Issues with test setup?**
1. Check Playwright documentation: https://playwright.dev
2. Review test artifacts: `playwright-report/index.html`
3. Inspect auth files: `tests/.auth/*.json`
4. Enable debug logging: `VITE_DEBUG_AUTH=true npm run test:e2e`
